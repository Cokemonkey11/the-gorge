package Locks

import AbilityObjEditing
import InstantDummyCaster
import ErrorHandling
import HashMap

constant ID_FIREBOLT = '!stn'
constant ID_STUNNED  = 'BPSE'

/**
    Implements boolean locks for a resource.

    A boolean locked is either locked (at least one uid associated), or unlocked
    (no uids associated).
*/
public module Lock<T>
    private static constant locks = new HashMap<T, int>()

    protected static function lock(T resource)
        if not locks.has(resource)
            locks.put(resource, 0)
        locks.put(resource, locks.get(resource) + 1)

    protected static function unlock(T resource) returns bool
        let them = locks.get(resource)
        locks.put(resource, them - 1)

        if them == 1
            callback(resource)
        return them == 1

    protected static function callback(T _t)
        skip

/**
    Multi-instanceable stuns for a unit.  The unit is unpaused if all uids are
    removed.

    Example usage:

    ```
    package Example
    import ClosureTimers
    init
        let u = createUnit(...)
        doPeriodically(3.) ->
            StunLocks.add(u, 'ev3s')
            doAfter(1.) ->
                StunLocks.remove(u, 'ev3s')
        doPeriodically(9.) ->
            StunLocks.add(u, 'ev9s')
            doAfter(3.) ->
                StunLocks.remove(u, 'ev9s')
    ```

    In the above example, the unit is paused/stunned whenever either of the
    competing StunLocks is held.
*/
public class StunLocks
    use Lock<unit>

    override static function callback(unit u)
        u.removeAbility(ID_STUNNED)

    construct()
        error("StunLocks shouldn't be instantiated")

    static function add(unit u)
        lock(u)
        InstantDummyCaster.castTarget(players[PLAYER_NEUTRAL_AGGRESSIVE], ID_FIREBOLT, 1, "firebolt", u, u.getPos())

    static function remove(unit u) returns bool
        return unlock(u)

@compiletime function gen_firebolt()
    new AbilityDefinitionFireBolt(ID_FIREBOLT)
        ..setDamage(1, 0.)
        ..setDummyAbility()
        ..setMissileArt("")
        ..setDurationNormal(1, 999999.)
